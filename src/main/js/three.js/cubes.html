<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - interactive cubes</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace, serif;
            background-color: #f0f0f0;
            margin: 0;
            overflow: hidden;
        }
    </style>
    <script type="text/javascript" src="three.js"></script>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
</head>
<body>


<script style="display:none">
    <!--
    // stats.js - http://github.com/mrdoob/stats.js
    var Stats = function () {
        var l = Date.now(), m = l, g = 0, n = Infinity, o = 0, h = 0, p = Infinity, q = 0, r = 0, s = 0, f = document.createElement("div");
        f.id = "stats";
        f.addEventListener("mousedown", function (b) {
            b.preventDefault();
            t(++s % 2)
        }, !1);
        f.style.cssText = "width:80px;opacity:0.9;cursor:pointer";
        var a = document.createElement("div");
        a.id = "fps";
        a.style.cssText = "padding:0 0 3px 3px;text-align:left;background-color:#002";
        f.appendChild(a);
        var i = document.createElement("div");
        i.id = "fpsText";
        i.style.cssText = "color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";
        i.innerHTML = "FPS";
        a.appendChild(i);
        var c = document.createElement("div");
        c.id = "fpsGraph";
        c.style.cssText = "position:relative;width:74px;height:30px;background-color:#0ff";
        for (a.appendChild(c); 74 > c.children.length;) {
            var j = document.createElement("span");
            j.style.cssText = "width:1px;height:30px;float:left;background-color:#113";
            c.appendChild(j)
        }
        var d = document.createElement("div");
        d.id = "ms";
        d.style.cssText = "padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";
        f.appendChild(d);
        var k = document.createElement("div");
        k.id = "msText";
        k.style.cssText = "color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";
        k.innerHTML = "MS";
        d.appendChild(k);
        var e = document.createElement("div");
        e.id = "msGraph";
        e.style.cssText = "position:relative;width:74px;height:30px;background-color:#0f0";
        for (d.appendChild(e); 74 > e.children.length;)j = document.createElement("span"), j.style.cssText = "width:1px;height:30px;float:left;background-color:#131", e.appendChild(j);
        var t = function (b) {
            s = b;
            switch (s) {
                case 0:
                    a.style.display =
                            "block";
                    d.style.display = "none";
                    break;
                case 1:
                    a.style.display = "none", d.style.display = "block"
            }
        };
        return {
            REVISION: 11, domElement: f, setMode: t, begin: function () {
                l = Date.now()
            }, end: function () {
                var b = Date.now();
                g = b - l;
                n = Math.min(n, g);
                o = Math.max(o, g);
                k.textContent = g + " MS (" + n + "-" + o + ")";
                var a = Math.min(30, 30 - 30 * (g / 200));
                e.appendChild(e.firstChild).style.height = a + "px";
                r++;
                b > m + 1E3 && (h = Math.round(1E3 * r / (b - m)), p = Math.min(p, h), q = Math.max(q, h), i.textContent = h + " FPS (" + p + "-" + q + ")", a = Math.min(30, 30 - 30 * (h / 100)), c.appendChild(c.firstChild).style.height =
                        a + "px", m = b, r = 0);
                return b
            }, update: function () {
                l = this.end()
            }
        }
    };

    //-->
</script>

<script>
    var container = document.createElement('div');
    var camera, scene, raycaster, renderer;
    var mousePosition = new THREE.Vector2();
    var intersected = null;
    var theta = 0;
    var stats;

    var width = 1800;
    var height = 1800;
    var pad = 50;

    var data = {
        "name": "root",
        "value": 90,
        "height": 10,
        "children": [
            {"name": "a", "value": 10, "height": 30},
            {"name": "b", "value": 20, "height": 50},
            {"name": "c", "value": 60, "height": 20}
        ]
    };

    var radius = 2400;
    var theta = 0;
    var phi = 0;

    init(container, data);
    animate();

    function updateCamera() {
        camera.position.x = (width / 2) + radius * Math.cos(theta) * Math.sin(phi);
        camera.position.y = (height / 2) + radius * Math.sin(theta) * Math.sin(phi);
        camera.position.z = radius * Math.cos(phi);
        camera.lookAt(new THREE.Vector3(width / 2, height / 2, 0));
    }

    function init(container, rootNode) {
        document.body.appendChild(container);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);
        updateCamera();
//        camera.rotation.x += 1.3;
//        camera.rotation.y += -0.6;
//        camera.rotation.z += 0;

        scene = new THREE.Scene();
        scene.position.x = 0;
        scene.position.y = 0;
        scene.position.z = 0;

        var light = new THREE.DirectionalLight(0xffffff, 1.2);
        light.position.set(-1, -1, 1).normalize();
        scene.add(light);

        var color = d3.scale.category20();
        var treemap = d3.layout.treemap()
                .size([width, height])
                .padding(pad)
                .round(true)
                .value(_.property("value"));
        treemap.nodes(rootNode);

        var r = 1000;
        var step = 0.3;
        for (var t = 0; t <= Math.PI * 3; t += step) {
            for (var p = 0; p <= Math.PI * 3; p += step) {
                var x = (width / 2) + r * Math.cos(t) * Math.sin(p);
                var y = (height / 2) + r * Math.sin(t) * Math.sin(p);
                var z = r * Math.cos(p);

                var geometry = new THREE.BoxGeometry(5, 5, 5);
                var object = new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({color: 0}));
                object.position.x = x;
                object.position.y = y;
                object.position.z = z;
                scene.add(object);
            }
        }

        var createNodeObjects = function(node, z) {
            var geometry = new THREE.BoxGeometry(node.dx, node.dy, node.height * 10);
            var object = new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({color: color(node.name)}));
            object.position.x = node.x + (node.dx / 2);
            object.position.y = node.y + (node.dy / 2);
            object.position.z = z + (node.height * 10 / 2);
            object.node = node;
            scene.add(object);

            if (node.children !== undefined) {
                node.children.forEach(function(child) {
                    createNodeObjects(child, z + node.height); // TODO scale
                })
            }
        };
        createNodeObjects(rootNode, 0);

        raycaster = new THREE.Raycaster();

        renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0xf0f0f0);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.sortObjects = false;
        container.appendChild(renderer.domElement);

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        container.appendChild(stats.domElement);

        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);
        window.addEventListener("keypress", function(event) {
            var key = (event.key !== undefined ? event.key : event.keyCode);
            console.log(key);

            if (key === 114/*r*/) {
                window.rotationMode = !window.rotationMode;
                console.log("Rotation mode: " + window.rotationMode);
            }
            if (key === 106/*j*/) theta -= 0.1;
            if (key === 108/*l*/) theta += 0.1;
            if (key === 105/*i*/) phi -= 0.1;
            if (key === 107/*k*/) phi += 0.1;
            if (key === 117/*u*/) radius -= 50;
            if (key === 111/*o*/) radius += 50;
            updateCamera();

            function doStep(key, target, stepSize) {
                if (key === 122/*z*/) target.z += stepSize;
                if (key === 90/*Z*/) target.z -= stepSize;
                if (key === 121/*y*/) target.y += stepSize;
                if (key === 89/*Y*/) target.y -= stepSize;
                if (key === 120/*x*/) target.x += stepSize;
                if (key === 88/*X*/) target.x -= stepSize;
                console.log(target.x + "," + target.y + "," + target.z);
            }
//            doStep(key, scene.rotation, 0.1);
            if (window.rotationMode) {
                doStep(key, camera.rotation, "rotation", 0.1);
            } else {
                doStep(key, camera.position, "position", 20);
            }
        });
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onDocumentMouseMove(event) {
        event.preventDefault();
        mousePosition.x = (event.clientX / window.innerWidth) * 2 - 1;
        mousePosition.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }

//    function onDocumentMouseMove(event) {
//        var windowHalfX = window.innerWidth / 2;
//        var windowHalfY = window.innerHeight / 2;
//        mousePosition.x = event.clientX - windowHalfX;
//        mousePosition.y = event.clientY - windowHalfY;
//    }

    /*function onDocumentTouchStart(event) {
        if (event.touches.length > 1) {
            event.preventDefault();
            mouseX = event.touches[0].pageX - windowHalfX;
            mouseY = event.touches[0].pageY - windowHalfY;
        }
    }

    function onDocumentTouchMove(event) {
        if (event.touches.length == 1) {
            event.preventDefault();
            mouseX = event.touches[0].pageX - windowHalfX;
            mouseY = event.touches[0].pageY - windowHalfY;
        }
    }*/

    function animate() {
        requestAnimationFrame(animate);
        render();
        stats.update();
    }

    function render() {
//        camera.position.x = radius * Math.sin(THREE.Math.degToRad(theta));
//        camera.position.y = radius * Math.sin(THREE.Math.degToRad(theta));
//        camera.position.x += (mousePosition.x * window.innerWidth - camera.position.x) * .05;
//        camera.position.y += (-mousePosition.y * window.innerHeight + 200 - camera.position.y) * .05;
//        camera.position.z = 700;
        camera.updateMatrixWorld();

        raycaster.setFromCamera(mousePosition, camera);
        var intersects = raycaster.intersectObjects(scene.children);
        var newIntersected = intersects.length > 0 ? intersects[0].object : null;

        if (newIntersected !== null) {
            if (intersected !== newIntersected) {
                if (intersected !== null) intersected.material.emissive.setHex(intersected.currentHex);
                intersected = newIntersected;
                intersected.currentHex = intersected.material.emissive.getHex();
                intersected.material.emissive.setHex(0x111111);
//                console.log(intersected.node.name); TODO
            }
        } else {
            if (intersected !== null) intersected.material.emissive.setHex(intersected.currentHex);
            intersected = null;
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
